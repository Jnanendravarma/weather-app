<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherSphere - Real-time Weather App v2.0</title>
    <meta name="description" content="Beautiful real-time weather application with advanced features, stunning animations, and offline support">
    <meta name="keywords" content="weather, forecast, real-time, weather app, temperature, humidity, wind, rain, snow">
    <meta name="author" content="WeatherSphere">
    
    <!-- Version stamp for cache busting -->
    <meta name="version" content="2.0-voice-enabled">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- iOS meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WeatherSphere">
    
    <!-- Icons - Using generated PNG files -->
    <link rel="icon" type="image/png" sizes="32x32" href="./icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon-16.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <!-- External Resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --card-bg: rgba(255, 255, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, #000428, #004e92);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            background-attachment: fixed;
            overflow-x: hidden;
            position: relative;
        }

        /* Particle Background */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float-particle 15s infinite linear;
        }

        @keyframes float-particle {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Weather-based background animations */
        .weather-bg-sunny {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: sunny-gradient 8s ease-in-out infinite;
        }

        .weather-bg-cloudy {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
        }

        .weather-bg-rainy {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
        }

        .weather-bg-snowy {
            background: linear-gradient(135deg, #e6ddd4 0%, #d5d4d0 100%);
        }

        @keyframes sunny-gradient {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(20deg); }
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s;
        }

        .app-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(to right, #fff, #4cc9f0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .theme-toggle {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            color: var(--light);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2);
        }

        .settings-toggle {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            color: var(--light);
            border: none;
            z-index: 100;
            position: relative;
        }

        .settings-toggle:hover {
            transform: scale(1.1) rotate(90deg);
            background: rgba(255, 255, 255, 0.2);
        }

        .unit-toggle {
            display: flex;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 5px;
        }

        .temp-unit {
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .temp-unit.active {
            background: var(--accent);
            color: white;
        }

        /* Light theme styles */
        body.light-theme {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: var(--dark);
        }

        .light-theme .app-title {
            background: linear-gradient(to right, #2d3436, #74b9ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .light-theme .current-weather,
        .light-theme .forecast-card,
        .light-theme .chart-container {
            background: rgba(255, 255, 255, 0.9);
            color: var(--dark);
        }

        .light-theme .search-input {
            background: rgba(255, 255, 255, 0.9);
            color: var(--dark);
        }

        .light-theme .search-input::placeholder {
            color: rgba(0, 0, 0, 0.6);
        }

        /* Search Container */
        .search-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 30px;
            animation: fadeIn 1s;
        }

        .search-input {
            width: 100%;
            padding: 15px 120px 15px 20px;
            border: none;
            border-radius: 50px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            color: var(--light);
            font-size: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.4s;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 5px 20px rgba(67, 97, 238, 0.3);
            transform: translateY(-2px);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-btn, .voice-btn, .location-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--light);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            border-radius: 50%;
        }

        .search-btn {
            right: 10px;
        }

        .voice-btn {
            right: 50px;
        }

        .location-btn {
            right: 90px;
        }

        .search-btn:hover, .voice-btn:hover, .location-btn:hover {
            color: var(--accent);
            transform: translateY(-50%) scale(1.1);
            background: rgba(255, 255, 255, 0.1);
        }

        .voice-btn.listening {
            color: #ff4757;
            animation: pulse-red 1s infinite;
        }

        .voice-btn.processing {
            color: #ffa502;
            animation: spin 1s linear infinite;
        }

        .voice-btn.disabled {
            display: none !important;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Current Weather */
        .current-weather {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.8s;
            transition: all 0.5s;
            perspective: 1000px;
        }

        .current-weather:hover {
            transform: translateY(-5px) rotateX(2deg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .weather-card-flip {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .weather-card-flip.flipped {
            transform: rotateY(180deg);
        }

        .weather-card-front, .weather-card-back {
            backface-visibility: hidden;
            position: relative;
        }

        .weather-card-back {
            transform: rotateY(180deg);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .location-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .location-name {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .location-date {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .current-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
        }

        .temperature-container {
            display: flex;
            align-items: flex-start;
        }

        .current-temp {
            font-size: 5rem;
            font-weight: 300;
            line-height: 1;
            margin-right: 10px;
            background: linear-gradient(to right, #fff, #4cc9f0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .temp-unit {
            font-size: 1.5rem;
            margin-top: 10px;
            cursor: pointer;
            user-select: none;
        }

        .weather-icon-container {
            text-align: center;
        }

        .weather-icon {
            width: 120px;
            height: 120px;
            object-fit: contain;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
            animation: weather-icon-float 3s ease-in-out infinite;
            transition: all 0.5s;
        }

        .weather-icon:hover {
            transform: scale(1.1) rotate(5deg);
        }

        @keyframes weather-icon-float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
            }
            25% { 
                transform: translateY(-10px) rotate(2deg);
            }
            50% { 
                transform: translateY(-5px) rotate(-1deg);
            }
            75% { 
                transform: translateY(-8px) rotate(1deg);
            }
        }

        /* Glowing temperature effect */
        .current-temp {
            font-size: 5rem;
            font-weight: 300;
            line-height: 1;
            margin-right: 10px;
            background: linear-gradient(45deg, #fff, #4cc9f0, #f72585, #4cc9f0);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: gradient-shift 4s ease-in-out infinite;
            text-shadow: 0 0 20px rgba(76, 201, 240, 0.5);
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .weather-description {
            font-size: 1.2rem;
            text-transform: capitalize;
            margin-top: 10px;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .detail-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .detail-card:hover {
            transform: translateY(-5px) scale(1.02);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .detail-card:hover::before {
            left: 100%;
        }

        .detail-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            color: var(--accent);
            animation: icon-pulse 2s ease-in-out infinite;
        }

        @keyframes icon-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .detail-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .detail-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 3px;
        }

        /* Forecast Section */
        .forecast-section {
            margin-top: 40px;
            animation: fadeIn 1s;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
            color: var(--accent);
        }

        .forecast-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 20px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
        }

        .forecast-container::-webkit-scrollbar {
            height: 8px;
        }

        .forecast-container::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 10px;
        }

        .forecast-card {
            min-width: 150px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: fadeInRight 0.5s;
            position: relative;
            overflow: hidden;
        }

        .forecast-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(45deg, #4cc9f0, #f72585);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .forecast-card:hover {
            transform: translateY(-12px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
        }

        .forecast-card:hover::after {
            transform: scaleX(1);
        }

        .forecast-icon {
            width: 60px;
            height: 60px;
            margin: 10px auto;
            filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.2));
            transition: all 0.3s;
        }

        .forecast-card:hover .forecast-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .forecast-temps {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .forecast-high {
            font-weight: 600;
            color: #ff9e00;
        }

        .forecast-low {
            opacity: 0.7;
        }

        /* Recent Searches */
        .recent-searches {
            margin-top: 40px;
            animation: fadeIn 1s;
        }

        .recent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .recent-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .recent-tag:hover {
            background: var(--accent);
            transform: scale(1.05);
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: float 6s ease-in-out infinite;
        }

        /* Responsive Design */
        
        /* Large tablets and small desktops */
        @media (max-width: 1024px) {
            .app-container {
                padding: 15px;
                max-width: 95%;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .recommendations-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        /* Tablets */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px 0;
            }
            
            .header-controls {
                align-self: flex-end;
                gap: 15px;
            }

            .current-main {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .temperature-container {
                justify-content: center;
                margin-bottom: 20px;
            }
            
            .current-temp {
                font-size: 5rem;
            }

            .weather-details {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .forecast-container {
                gap: 15px;
                padding: 10px;
            }

            .forecast-card {
                min-width: 120px;
                padding: 15px;
            }
            
            .search-container {
                padding: 0 10px;
            }
            
            .search-input {
                padding: 15px 20px;
                font-size: 1rem;
            }
            
            .search-btn, .voice-btn, .location-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .search-btn {
                right: 8px;
            }
            
            .voice-btn {
                right: 58px;
            }
            
            .location-btn {
                right: 108px;
            }
        }

        /* Large mobile phones */
        @media (max-width: 640px) {
            .app-container {
                padding: 10px;
                margin: 10px auto;
            }
            
            .app-title {
                font-size: 2rem;
            }
            
            .current-temp {
                font-size: 4.5rem;
            }
            
            .weather-details {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .detail-card {
                padding: 15px;
            }
            
            .recommendations-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .recent-searches {
                padding: 15px;
            }
            
            .recent-tags {
                gap: 8px;
            }
            
            .recent-tag {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }

        /* Small mobile phones */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            
            .app-container {
                padding: 8px;
                margin: 5px auto;
            }
            
            .app-header {
                gap: 10px;
                padding: 10px 0;
            }
            
            .app-title {
                font-size: 1.8rem;
            }
            
            .header-controls {
                gap: 10px;
            }
            
            .theme-toggle, .settings-toggle {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .unit-toggle {
                gap: 5px;
            }
            
            .temp-unit {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .search-container {
                margin: 15px 0;
            }
            
            .search-input {
                padding: 12px 15px;
                font-size: 0.9rem;
                padding-right: 140px;
            }
            
            .search-btn, .voice-btn, .location-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .search-btn {
                right: 6px;
            }
            
            .voice-btn {
                right: 50px;
            }
            
            .location-btn {
                right: 94px;
            }
            
            .current-main {
                gap: 15px;
            }
            
            .current-temp {
                font-size: 3.5rem;
            }
            
            .weather-description {
                font-size: 1rem;
            }
            
            .weather-details {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .detail-card {
                padding: 12px;
                flex-direction: row;
                align-items: center;
                gap: 15px;
            }
            
            .detail-icon {
                font-size: 1.2rem;
                min-width: 25px;
            }
            
            .detail-value {
                font-size: 1rem;
                margin-bottom: 2px;
            }
            
            .detail-label {
                font-size: 0.8rem;
            }

            .forecast-card {
                min-width: 90px;
                padding: 12px 8px;
            }
            
            .forecast-day {
                font-size: 0.8rem;
            }
            
            .forecast-icon {
                width: 40px;
                height: 40px;
            }
            
            .forecast-high, .forecast-low {
                font-size: 0.9rem;
            }
            
            .section-title {
                font-size: 1.3rem;
            }
            
            .chart-title {
                font-size: 1rem;
            }
            
            .recommendation-card {
                padding: 15px;
            }
            
            .recommendation-title {
                font-size: 1rem;
            }
            
            .recommendation-content {
                font-size: 0.9rem;
                line-height: 1.5;
            }
            
            .recommendation-tag {
                padding: 3px 8px;
                font-size: 0.7rem;
            }
        }

        /* Extra small devices */
        @media (max-width: 360px) {
            .app-container {
                padding: 5px;
                margin: 2px auto;
            }
            
            .app-title {
                font-size: 1.6rem;
            }
            
            .current-temp {
                font-size: 3rem;
            }
            
            .search-input {
                padding: 10px 12px;
                padding-right: 130px;
                font-size: 0.85rem;
            }
            
            .search-btn, .voice-btn, .location-btn {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .search-btn {
                right: 5px;
            }
            
            .voice-btn {
                right: 44px;
            }
            
            .location-btn {
                right: 83px;
            }
            
            .forecast-card {
                min-width: 80px;
                padding: 10px 6px;
            }
            
            .forecast-icon {
                width: 35px;
                height: 35px;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--light);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Rain effect for rainy weather */
        .rain-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .raindrop {
            position: absolute;
            background: linear-gradient(transparent, rgba(255, 255, 255, 0.6), transparent);
            width: 2px;
            height: 30px;
            animation: fall 1s linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }

        /* Snow effect for snowy weather */
        .snow-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .snowflake {
            position: absolute;
            color: white;
            user-select: none;
            pointer-events: none;
            animation: snowfall 10s linear infinite;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-animation {
            text-align: center;
            color: white;
        }

        .weather-loader {
            width: 80px;
            height: 80px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Notification system */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #4cc9f0;
        }

        .notification.error {
            border-left: 4px solid #f72585;
        }

        /* Charts section */
        .charts-section {
            margin-top: 40px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Smart Recommendations */
        .recommendations-section {
            margin-top: 40px;
            animation: fadeIn 1s;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .recommendation-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .recommendation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, #4cc9f0, #f72585);
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .recommendation-icon {
            font-size: 1.5rem;
            margin-right: 10px;
            color: var(--accent);
        }

        .recommendation-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .recommendation-content {
            line-height: 1.6;
            opacity: 0.9;
        }

        .recommendation-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .recommendation-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .settings-modal.show {
            display: flex;
            opacity: 1;
        }

        .settings-content {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .settings-modal.show .settings-content {
            transform: scale(1);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-header h3 {
            margin: 0;
            color: var(--light);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-settings {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-settings:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .settings-body {
            padding: 20px 25px;
        }

        .setting-group {
            margin-bottom: 30px;
        }

        .setting-group:last-child {
            margin-bottom: 0;
        }

        .setting-group h4 {
            color: var(--light);
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.9;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item label {
            color: var(--light);
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            z-index: 10;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
            z-index: 12;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            transition: 0.3s;
            border-radius: 25px;
            z-index: 11;
            pointer-events: all;
        }

        .toggle-slider:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .toggle-slider {
            background: var(--accent);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(25px);
        }

        /* Settings Modal Responsive Design */
        @media (max-width: 768px) {
            .settings-content {
                width: 95%;
                max-height: 90vh;
                margin: 5vh auto;
            }
            
            .settings-header {
                padding: 15px 20px;
            }
            
            .settings-header h3 {
                font-size: 1.2rem;
            }
            
            .settings-body {
                padding: 15px 20px;
            }
            
            .setting-group h4 {
                font-size: 1rem;
            }
            
            .setting-item {
                padding: 10px 0;
            }
            
            .setting-item label {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .settings-content {
                width: 98%;
                max-height: 95vh;
                margin: 2.5vh auto;
                border-radius: 15px;
            }
            
            .settings-header {
                padding: 12px 15px;
            }
            
            .settings-header h3 {
                font-size: 1.1rem;
            }
            
            .settings-body {
                padding: 12px 15px;
            }
            
            .setting-group {
                margin-bottom: 20px;
            }
            
            .setting-group h4 {
                font-size: 0.95rem;
                margin-bottom: 12px;
            }
            
            .setting-item {
                padding: 8px 0;
            }
            
            .setting-item label {
                font-size: 0.85rem;
                flex: 1;
                margin-right: 10px;
            }
            
            .toggle-switch {
                width: 45px;
                height: 22px;
                flex-shrink: 0;
            }
            
            .toggle-slider:before {
                height: 16px;
                width: 16px;
                left: 3px;
                bottom: 3px;
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(22px);
            }
        }

        /* Touch-friendly improvements for mobile */
        @media (max-width: 768px) {
            /* Increase touch targets */
            .recent-tag, .recommendation-tag {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 8px 16px;
            }
            
            .theme-toggle, .settings-toggle {
                min-width: 44px;
                min-height: 44px;
            }
            
            .temp-unit {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Improve scrolling */
            .forecast-container {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            .recent-tags {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* Better hover states for touch */
            .recent-tag:active,
            .recommendation-tag:active,
            .theme-toggle:active,
            .settings-toggle:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
            
            /* Prevent text selection on touch */
            .search-btn, .voice-btn, .location-btn,
            .theme-toggle, .settings-toggle,
            .recent-tag, .recommendation-tag {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* Landscape mobile orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .app-container {
                padding: 5px 15px;
            }
            
            .app-header {
                padding: 5px 0;
                margin-bottom: 10px;
            }
            
            .current-main {
                flex-direction: row;
                align-items: center;
                gap: 20px;
            }
            
            .current-temp {
                font-size: 3rem;
            }
            
            .weather-details {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .detail-card {
                padding: 8px;
            }
            
            .forecast-container {
                gap: 10px;
            }
            
            .forecast-card {
                min-width: 80px;
                padding: 8px;
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .app-container {
                /* Ensure crisp rendering on retina displays */
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* Dark mode responsive adjustments */
        @media (prefers-color-scheme: dark) {
            body:not(.light-theme) {
                /* Enhanced dark mode for better mobile visibility */
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            }
        }

        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* No animations override */
        .no-animations * {
            animation-duration: 0s !important;
            animation-delay: 0s !important;
            transition-duration: 0s !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-animation">
            <div class="weather-loader"></div>
            <h2>WeatherSphere</h2>
            <p>Fetching beautiful weather data...</p>
        </div>
    </div>

    <!-- Particle Background -->
    <div class="particles-container" id="particles-container"></div>

    <!-- Weather Effects Container -->
    <div class="weather-effects" id="weather-effects"></div>

    <!-- Notification Container -->
    <div class="notification" id="notification"></div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h3><i class="fas fa-cog"></i> Settings</h3>
                <button class="close-settings" id="close-settings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="settings-body">
                <div class="setting-group">
                    <h4><i class="fas fa-microphone"></i> Voice Assistant</h4>
                    <div class="setting-item">
                        <label for="voice-enabled">Enable Voice Search</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="voice-enabled" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="voice-announcements">Voice Announcements</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="voice-announcements" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="voice-auto-speak">Auto-speak Weather</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="voice-auto-speak">
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h4><i class="fas fa-bell"></i> Notifications</h4>
                    <div class="setting-item">
                        <label for="weather-alerts">Weather Alerts</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="weather-alerts" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h4><i class="fas fa-palette"></i> Appearance</h4>
                    <div class="setting-item">
                        <label for="animations-enabled">Enable Animations</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="animations-enabled" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="weather-effects">Weather Effects</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="weather-effects-toggle" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <header class="app-header">
            <div>
                <h1 class="app-title">WeatherSphere</h1>
                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">v2.0 - Voice Enabled</div>
            </div>
            <div class="header-controls">
                <div class="settings-toggle" id="settings-toggle" title="Settings">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="theme-toggle" id="theme-toggle" title="Toggle Theme">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </div>
                <div class="unit-toggle">
                    <span class="temp-unit active" id="unit-c">°C</span>
                    <span class="temp-unit" id="unit-f">°F</span>
                </div>
            </div>
        </header>

        <div class="search-container">
            <input type="text" class="search-input" id="city-input" placeholder="Search for a city or say 'Hey Weather'...">
            <button class="search-btn" id="search-btn">
                <i class="fas fa-search"></i>
            </button>
            <button class="voice-btn" id="voice-btn" title="Voice Search">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="location-btn" id="location-btn" title="Get My Location">
                <i class="fas fa-location-crosshairs"></i>
            </button>
        </div>

        <main>
            <section class="current-weather">
                <div class="location-info">
                    <h2 class="location-name" id="city-name">--</h2>
                    <p class="location-date" id="date">--</p>
                </div>

                <div class="current-main">
                    <div class="temperature-container">
                        <span class="current-temp" id="temperature">--</span>
                    </div>

                    <div class="weather-icon-container">
                        <img src="" alt="Weather icon" class="weather-icon floating" id="weather-img">
                        <p class="weather-description" id="weather-description">--</p>
                    </div>
                </div>

                <div class="weather-details">
                    <div class="detail-card">
                        <i class="fas fa-tint detail-icon"></i>
                        <div>
                            <div class="detail-value" id="humidity-value">--%</div>
                            <div class="detail-label">Humidity</div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <i class="fas fa-wind detail-icon"></i>
                        <div>
                            <div class="detail-value" id="wind-speed">-- km/h</div>
                            <div class="detail-label">Wind Speed</div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <i class="fas fa-tachometer-alt detail-icon"></i>
                        <div>
                            <div class="detail-value" id="pressure-value">-- hPa</div>
                            <div class="detail-label">Pressure</div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <i class="fas fa-eye detail-icon"></i>
                        <div>
                            <div class="detail-value" id="visibility-value">-- km</div>
                            <div class="detail-label">Visibility</div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <i class="fas fa-thermometer-half detail-icon"></i>
                        <div>
                            <div class="detail-value" id="feels-like-value">--°</div>
                            <div class="detail-label">Feels Like</div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <i class="fas fa-sun detail-icon"></i>
                        <div>
                            <div class="detail-value" id="uv-index-value">--</div>
                            <div class="detail-label">UV Index</div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <i class="fas fa-leaf detail-icon"></i>
                        <div>
                            <div class="detail-value" id="air-quality-value">--</div>
                            <div class="detail-label">Air Quality</div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <i class="fas fa-compass detail-icon"></i>
                        <div>
                            <div class="detail-value" id="wind-direction">--</div>
                            <div class="detail-label">Wind Direction</div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <i class="fas fa-sun detail-icon"></i>
                        <div>
                            <div class="detail-value" id="sunrise-value">--:--</div>
                            <div class="detail-label">Sunrise</div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <i class="fas fa-moon detail-icon"></i>
                        <div>
                            <div class="detail-value" id="sunset-value">--:--</div>
                            <div class="detail-label">Sunset</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="forecast-section">
                <h2 class="section-title"><i class="fas fa-calendar-alt"></i> 5-Day Forecast</h2>
                <div class="forecast-container" id="forecast-container">
                    <!-- Forecast cards will be inserted here by JavaScript -->
                    <div class="forecast-card">
                        <div class="forecast-day">Mon</div>
                        <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="forecast-icon">
                        <div class="forecast-temps">
                            <span class="forecast-high">24°</span>
                            <span class="forecast-low">18°</span>
                        </div>
                    </div>
                    <div class="forecast-card">
                        <div class="forecast-day">Tue</div>
                        <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="forecast-icon">
                        <div class="forecast-temps">
                            <span class="forecast-high">24°</span>
                            <span class="forecast-low">18°</span>
                        </div>
                    </div>
                    <div class="forecast-card">
                        <div class="forecast-day">wed</div>
                        <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="forecast-icon">
                        <div class="forecast-temps">
                            <span class="forecast-high">24°</span>
                            <span class="forecast-low">18°</span>
                        </div>
                    </div>
                    <div class="forecast-card">
                        <div class="forecast-day">Thur</div>
                        <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="forecast-icon">
                        <div class="forecast-temps">
                            <span class="forecast-high">24°</span>
                            <span class="forecast-low">18°</span>
                        </div>
                    </div>
                    <div class="forecast-card">
                        <div class="forecast-day">Fri</div>
                        <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="forecast-icon">
                        <div class="forecast-temps">
                            <span class="forecast-high">24°</span>
                            <span class="forecast-low">18°</span>
                        </div>
                    </div>




                    <!-- More forecast cards... -->
                </div>
            </section>

            <section class="recent-searches">
                <h2 class="section-title"><i class="fas fa-history"></i> Recent Searches</h2>
                <div class="recent-tags" id="recent-list">
                    <div class="recent-tag">London</div>
                    <div class="recent-tag">New York</div>
                    <div class="recent-tag">Tokyo</div>
                </div>
            </section>

            <!-- Interactive Charts Section -->
            <section class="charts-section">
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-line"></i> 24-Hour Temperature</h3>
                    <canvas id="temperatureChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-tint"></i> Humidity Levels</h3>
                    <canvas id="humidityChart" width="400" height="200"></canvas>
                </div>
            </section>

            <!-- Smart Recommendations Section -->
            <section class="recommendations-section">
                <h2 class="section-title"><i class="fas fa-lightbulb"></i> Smart Recommendations</h2>
                <div class="recommendations-grid" id="recommendations-grid">
                    <!-- Recommendations will be populated by JavaScript -->
                </div>
            </section>
        </main>
    </div>

    <script>
        // Weather App Configuration
        const API_BASE = window.location.origin + '/api'; // Full URL to our backend proxy

        // Helper function to check if server is ready
        async function checkServerStatus() {
            try {
                const response = await fetch(window.location.origin + '/');
                return response.ok;
            } catch (error) {
                console.warn('⚠️ Server not ready yet, retrying...');
                return false;
            }
        }
        
        // Application state
        let currentUnit = 'metric';
        let weatherData = null;
        let forecastData = null;
        let temperatureChart = null;
        let humidityChart = null;
        let speechRecognition = null;
        let speechSynthesis = null;
        let isListening = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if server is ready before initializing
            showNotification('🚀 Starting WeatherSphere...', 'info');
            
            let serverReady = false;
            let attempts = 0;
            const maxAttempts = 10;
            
            while (!serverReady && attempts < maxAttempts) {
                serverReady = await checkServerStatus();
                if (!serverReady) {
                    attempts++;
                    showNotification(`⏳ Waiting for server... (${attempts}/${maxAttempts})`, 'warning');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            if (!serverReady) {
                showNotification('❌ Server not responding. Please refresh the page.', 'error');
                return;
            }
            
            showNotification('✅ Server ready! Loading weather data...', 'success');
            
            initializeApp();
            createParticleBackground();
            setupEventListeners();
            registerServiceWorker();
            initializeSpeechFeatures();
            loadUserPreferences();
            
            // Hide loading screen after initial setup
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
            }, 2000);

            // Try to get user's location for initial weather
            getCurrentLocationWeather();
        });

        // Register service worker for PWA support
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showNotification('App updated! Refresh to see the latest version.', 'success');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
        }

        // Initialize app components
        function initializeApp() {
            setCurrentDate();
            initializeCharts();
        }

        // Create animated particle background
        function createParticleBackground() {
            const container = document.getElementById('particles-container');
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.width = Math.random() * 4 + 2 + 'px';
                particle.style.height = particle.style.width;
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                container.appendChild(particle);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            const searchBtn = document.getElementById('search-btn');
            const cityInput = document.getElementById('city-input');
            const voiceBtn = document.getElementById('voice-btn');
            const locationBtn = document.getElementById('location-btn');
            const themeToggle = document.getElementById('theme-toggle');
            
            searchBtn.addEventListener('click', () => searchWeather());
            cityInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchWeather();
            });

            // Voice search
            voiceBtn.addEventListener('click', () => toggleVoiceSearch());

            // Location button
            locationBtn.addEventListener('click', () => getCurrentLocationWeather());

            // Theme toggle
            themeToggle.addEventListener('click', () => toggleTheme());

            // Settings modal
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettings = document.getElementById('close-settings');
            
            console.log('🔧 Settings elements found:', {
                toggle: !!settingsToggle,
                modal: !!settingsModal,
                closeBtn: !!closeSettings
            });
            
            if (settingsToggle) {
                settingsToggle.addEventListener('click', () => {
                    console.log('🔧 Settings button clicked!');
                    openSettings();
                });
                console.log('✅ Settings toggle event listener added');
            } else {
                console.error('❌ Settings toggle button not found!');
            }
            
            if (closeSettings) {
                closeSettings.addEventListener('click', () => closeSettingsModal());
            }
            
            if (settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    if (e.target === settingsModal) closeSettingsModal();
                });
            }

            // Settings toggles - with enhanced click handling
            try {
                const voiceEnabledToggle = document.getElementById('voice-enabled');
                const voiceAnnouncementsToggle = document.getElementById('voice-announcements');
                const voiceAutoSpeakToggle = document.getElementById('voice-auto-speak');
                const weatherAlertsToggle = document.getElementById('weather-alerts');
                const animationsToggle = document.getElementById('animations-enabled');
                const effectsToggle = document.getElementById('weather-effects-toggle');

                console.log('🔧 Setting up toggle event listeners:', {
                    voiceEnabled: !!voiceEnabledToggle,
                    voiceAnnouncements: !!voiceAnnouncementsToggle,
                    voiceAutoSpeak: !!voiceAutoSpeakToggle,
                    weatherAlerts: !!weatherAlertsToggle,
                    animations: !!animationsToggle,
                    effects: !!effectsToggle
                });

                // Helper function to setup toggle with multiple event handlers
                function setupToggle(toggle, callback, name) {
                    if (toggle) {
                        // Handle input change event
                        toggle.addEventListener('change', () => {
                            callback();
                        });
                        
                        // Also handle clicks on the slider
                        const slider = toggle.nextElementSibling;
                        if (slider && slider.classList.contains('toggle-slider')) {
                            slider.addEventListener('click', (e) => {
                                e.preventDefault();
                                toggle.checked = !toggle.checked;
                                callback();
                            });
                        }
                        
                        // Handle label clicks
                        const label = toggle.closest('.setting-item').querySelector('label');
                        if (label) {
                            label.addEventListener('click', (e) => {
                                e.preventDefault();
                                toggle.checked = !toggle.checked;
                                callback();
                            });
                            label.style.cursor = 'pointer';
                        }
                    }
                }

                // Setup all toggles
                setupToggle(voiceEnabledToggle, updateVoiceSettings, 'Voice Enabled');
                setupToggle(voiceAnnouncementsToggle, updateVoiceSettings, 'Voice Announcements');
                setupToggle(voiceAutoSpeakToggle, updateVoiceSettings, 'Voice Auto-speak');
                setupToggle(weatherAlertsToggle, updateNotificationSettings, 'Weather Alerts');
                setupToggle(animationsToggle, updateAnimationSettings, 'Animations');
                setupToggle(effectsToggle, updateEffectsSettings, 'Weather Effects');

                console.log('✅ All toggle event listeners set up successfully');
            } catch (error) {
                console.error('❌ Error setting up toggle event listeners:', error);
            }

            // Unit toggle
            document.getElementById('unit-c').addEventListener('click', () => switchUnit('metric'));
            document.getElementById('unit-f').addEventListener('click', () => switchUnit('imperial'));

            // Recent searches
            document.querySelectorAll('.recent-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    document.getElementById('city-input').value = tag.textContent;
                    searchWeather();
                });
            });
        }

        // Initialize speech features
        function initializeSpeechFeatures() {
            // Speech Recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                speechRecognition = new SpeechRecognition();
                speechRecognition.continuous = false;
                speechRecognition.interimResults = false;
                speechRecognition.lang = 'en-US';

                speechRecognition.onstart = () => {
                    isListening = true;
                    document.getElementById('voice-btn').classList.add('listening');
                    showNotification('Listening... Say a city name', 'success');
                };

                speechRecognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('city-input').value = transcript;
                    document.getElementById('voice-btn').classList.add('processing');
                    searchWeather();
                    speakWeather(`Searching weather for ${transcript}`);
                };

                speechRecognition.onerror = (event) => {
                    isListening = false;
                    document.getElementById('voice-btn').classList.remove('listening', 'processing');
                    showNotification('Voice search failed. Please try again.', 'error');
                };

                speechRecognition.onend = () => {
                    isListening = false;
                    document.getElementById('voice-btn').classList.remove('listening', 'processing');
                };
            }

            // Speech Synthesis
            if ('speechSynthesis' in window) {
                speechSynthesis = window.speechSynthesis;
            }
        }

        // Toggle voice search
        function toggleVoiceSearch() {
            // Check if voice is enabled in settings
            if (!voiceSettings.enabled) {
                showNotification('Voice search is disabled. Enable it in settings.', 'error');
                return;
            }

            if (!speechRecognition) {
                showNotification('Voice search not supported in this browser', 'error');
                return;
            }

            if (isListening) {
                speechRecognition.stop();
            } else {
                speechRecognition.start();
            }
        }

        // Speak weather information
        function speakWeather(text) {
            // Check if voice announcements are enabled
            if (!voiceSettings.announcements || !speechSynthesis) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.8;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            speechSynthesis.speak(utterance);
        }

        // Toggle theme
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            body.classList.toggle('light-theme');
            
            if (body.classList.contains('light-theme')) {
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            } else {
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Load user preferences
        function loadUserPreferences() {
            // Load theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('theme-icon').className = 'fas fa-sun';
            }

            // Load unit preference
            const savedUnit = localStorage.getItem('unit');
            if (savedUnit) {
                currentUnit = savedUnit;
                document.getElementById('unit-c').classList.toggle('active', savedUnit === 'metric');
                document.getElementById('unit-f').classList.toggle('active', savedUnit === 'imperial');
            }

            // Load voice settings
            loadVoiceSettings();
        }

        // Settings Modal Functions
        function openSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal) {
                modal.classList.add('show');
                showNotification('⚙️ Settings opened', 'info');
            } else {
                console.error('❌ Settings modal not found!');
                showNotification('❌ Settings modal not found', 'error');
            }
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settings-modal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Voice Settings Management
        let voiceSettings = {
            enabled: true,
            announcements: true,
            autoSpeak: false
        };

        function loadVoiceSettings() {
            const saved = localStorage.getItem('voiceSettings');
            if (saved) {
                voiceSettings = JSON.parse(saved);
            }
            
            // Wait for DOM to be ready before updating elements
            setTimeout(() => {
                // Update toggle states
                const voiceEnabledToggle = document.getElementById('voice-enabled');
                const voiceAnnouncementsToggle = document.getElementById('voice-announcements');
                const voiceAutoSpeakToggle = document.getElementById('voice-auto-speak');
                
                if (voiceEnabledToggle) {
                    voiceEnabledToggle.checked = voiceSettings.enabled;
                }
                if (voiceAnnouncementsToggle) {
                    voiceAnnouncementsToggle.checked = voiceSettings.announcements;
                }
                if (voiceAutoSpeakToggle) {
                    voiceAutoSpeakToggle.checked = voiceSettings.autoSpeak;
                }
                
                // Update voice button visibility
                updateVoiceButtonVisibility();
            }, 100);
        }

        function updateVoiceButtonVisibility() {
            const voiceBtn = document.getElementById('voice-btn');
            if (voiceBtn) {
                if (voiceSettings.enabled) {
                    voiceBtn.classList.remove('disabled');
                    voiceBtn.style.display = 'flex';
                    voiceBtn.title = 'Voice Search (Enabled)';
                } else {
                    voiceBtn.classList.add('disabled');
                    voiceBtn.style.display = 'none';
                    voiceBtn.title = 'Voice Search (Disabled in Settings)';
                }
            }
        }

        function updateVoiceSettings() {
            // Get current toggle states
            const voiceEnabledToggle = document.getElementById('voice-enabled');
            const voiceAnnouncementsToggle = document.getElementById('voice-announcements');
            const voiceAutoSpeakToggle = document.getElementById('voice-auto-speak');
            
            if (voiceEnabledToggle) {
                voiceSettings.enabled = voiceEnabledToggle.checked;
            }
            if (voiceAnnouncementsToggle) {
                voiceSettings.announcements = voiceAnnouncementsToggle.checked;
            }
            if (voiceAutoSpeakToggle) {
                voiceSettings.autoSpeak = voiceAutoSpeakToggle.checked;
            }
            
            // Save to localStorage
            localStorage.setItem('voiceSettings', JSON.stringify(voiceSettings));
            
            // Update voice button visibility and state
            updateVoiceButtonVisibility();
            
            // Provide user feedback with shorter messages
            if (voiceSettings.enabled) {
                showNotification('🎤 Voice features enabled!', 'success');
            } else {
                showNotification('🔇 Voice features disabled', 'info');
                
                // Stop any ongoing speech recognition
                if (window.isListening && window.speechRecognition) {
                    window.speechRecognition.stop();
                    window.isListening = false;
                }
                
                // Stop any ongoing speech synthesis
                if (window.speechSynthesis) {
                    window.speechSynthesis.cancel();
                }
            }
        }

        function updateNotificationSettings() {
            const weatherAlerts = document.getElementById('weather-alerts').checked;
            localStorage.setItem('weatherAlerts', weatherAlerts);
            showNotification(weatherAlerts ? 'Weather alerts enabled' : 'Weather alerts disabled', 'info');
        }

        function updateAnimationSettings() {
            const animationsEnabled = document.getElementById('animations-enabled').checked;
            localStorage.setItem('animationsEnabled', animationsEnabled);
            
            if (animationsEnabled) {
                document.body.classList.remove('no-animations');
                showNotification('Animations enabled', 'success');
            } else {
                document.body.classList.add('no-animations');
                showNotification('Animations disabled', 'info');
            }
        }

        function updateEffectsSettings() {
            const effectsEnabled = document.getElementById('weather-effects-toggle').checked;
            localStorage.setItem('weatherEffects', effectsEnabled);
            
            const effectsContainer = document.getElementById('weather-effects');
            if (effectsEnabled) {
                effectsContainer.style.display = 'block';
                showNotification('Weather effects enabled', 'success');
            } else {
                effectsContainer.style.display = 'none';
                showNotification('Weather effects disabled', 'info');
            }
        }

        // Test function for debugging settings
        window.testSettings = function() {
            console.log('🧪 Testing settings functionality...');
            
            // Test opening settings
            openSettings();
            
            // Test current toggle states
            setTimeout(() => {
                const toggles = {
                    voiceEnabled: document.getElementById('voice-enabled'),
                    voiceAnnouncements: document.getElementById('voice-announcements'),
                    voiceAutoSpeak: document.getElementById('voice-auto-speak')
                };
                
                console.log('📊 Current toggle states:', {
                    voiceEnabled: toggles.voiceEnabled?.checked,
                    voiceAnnouncements: toggles.voiceAnnouncements?.checked,
                    voiceAutoSpeak: toggles.voiceAutoSpeak?.checked
                });
                
                // Test toggling voice enabled
                if (toggles.voiceEnabled) {
                    console.log('🧪 Testing voice enabled toggle...');
                    toggles.voiceEnabled.checked = !toggles.voiceEnabled.checked;
                    toggles.voiceEnabled.dispatchEvent(new Event('change'));
                }
            }, 500);
        };

        // Get current location weather
        function getCurrentLocationWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        fetchWeatherByCoords(lat, lon);
                    },
                    error => {
                        console.log('Geolocation error:', error);
                        // Default to a popular city if geolocation fails
                        fetchWeatherByCity('London');
                    }
                );
            } else {
                fetchWeatherByCity('London');
            }
        }

        // Search weather for entered city
        function searchWeather() {
            const city = document.getElementById('city-input').value.trim();
            if (!city) {
                showNotification('Please enter a city name', 'error');
                return;
            }
            
            showLoading();
            fetchWeatherByCity(city);
        }

        // Fetch weather data by city name
        async function fetchWeatherByCity(city) {
            // Check if server is ready first
            const serverReady = await checkServerStatus();
            if (!serverReady) {
                showNotification('⚠️ Server starting up, please wait...', 'warning');
                // Wait a bit and try again
                setTimeout(() => fetchWeatherByCity(city), 2000);
                return;
            }

            // Check if offline and use cached data
            if (!navigator.onLine) {
                const cachedData = getCachedWeatherData(city);
                if (cachedData) {
                    updateWeatherDisplay(cachedData.weather, cachedData.forecast);
                    showNotification('Showing cached data (offline)', 'warning');
                    hideLoading();
                    return;
                }
            }
            
            try {
                // Current weather via our backend
                const weatherResponse = await fetch(
                    `${API_BASE}/weather?q=${encodeURIComponent(city)}&units=${currentUnit}`
                );
                
                if (!weatherResponse.ok) {
                    const contentType = weatherResponse.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await weatherResponse.json();
                        throw new Error(errorData.error || 'City not found');
                    } else {
                        // Received HTML instead of JSON - server issue
                        throw new Error('Server error - please try again in a moment');
                    }
                }

                weatherData = await weatherResponse.json();                // 5-day forecast via our backend
                const forecastResponse = await fetch(
                    `${API_BASE}/forecast?q=${encodeURIComponent(city)}&units=${currentUnit}`
                );
                
                forecastData = await forecastResponse.json();
                
                // Air quality data via our backend
                const lat = weatherData.coord.lat;
                const lon = weatherData.coord.lon;
                
                let airQualityData = null;
                try {
                    const airQualityResponse = await fetch(
                        `${API_BASE}/air-pollution?lat=${lat}&lon=${lon}`
                    );
                    airQualityData = await airQualityResponse.json();
                } catch (airErr) {
                    console.log('Air quality data not available:', airErr.message);
                }
                
                // Cache the data for offline use
                cacheWeatherData(city, {
                    weather: weatherData,
                    forecast: forecastData
                });
                
                updateWeatherDisplay(weatherData, forecastData, airQualityData);
                updateCharts();
                createWeatherEffects(weatherData.weather[0].main);
                generateSmartRecommendations(weatherData);
                saveRecentSearch(city);
                showNotification('Weather data updated successfully!', 'success');
                
                // Speak weather summary
                const summary = `Weather in ${weatherData.name}: ${Math.round(weatherData.main.temp)} degrees, ${weatherData.weather[0].description}`;
                speakWeather(summary);
                
                hideLoading();
                
            } catch (error) {
                console.error('Error fetching weather:', error);
                
                // Try to use cached data as fallback
                const cachedData = getCachedWeatherData(city);
                if (cachedData) {
                    updateWeatherDisplay(cachedData.weather, cachedData.forecast);
                    showNotification('Using cached data due to network error', 'warning');
                } else {
                    showNotification(`Failed to fetch weather data: ${error.message}`, 'error');
                }
                hideLoading();
            }
        }

        // Fetch weather data by coordinates
        async function fetchWeatherByCoords(lat, lon) {
            try {
                const weatherResponse = await fetch(
                    `${API_BASE}/weather/coords?lat=${lat}&lon=${lon}&units=${currentUnit}`
                );
                
                weatherData = await weatherResponse.json();
                
                const forecastResponse = await fetch(
                    `${API_BASE}/forecast?lat=${lat}&lon=${lon}&units=${currentUnit}`
                );
                
                forecastData = await forecastResponse.json();
                
                // Air quality data
                let airQualityData = null;
                try {
                    const airQualityResponse = await fetch(
                        `${API_BASE}/air-pollution?lat=${lat}&lon=${lon}`
                    );
                    airQualityData = await airQualityResponse.json();
                } catch (airErr) {
                    console.log('Air quality data not available:', airErr.message);
                }
                
                updateWeatherDisplay(weatherData, forecastData, airQualityData);
                updateCharts();
                createWeatherEffects(weatherData.weather[0].main);
                hideLoading();
                
            } catch (error) {
                console.error('Error fetching weather by coords:', error);
                fetchWeatherByCity('London'); // Fallback
            }
        }

        // Update weather display
        function updateWeatherDisplay(weather, forecast, airQuality) {
            // Current weather
            document.getElementById('city-name').textContent = `${weather.name}, ${weather.sys.country}`;
            document.getElementById('temperature').textContent = Math.round(weather.main.temp);
            document.getElementById('weather-description').textContent = weather.weather[0].description;
            document.getElementById('weather-img').src = `https://openweathermap.org/img/wn/${weather.weather[0].icon}@4x.png`;
            
            // Weather details
            document.getElementById('humidity-value').textContent = weather.main.humidity + '%';
            document.getElementById('wind-speed').textContent = Math.round(weather.wind.speed * 3.6) + ' km/h';
            document.getElementById('pressure-value').textContent = weather.main.pressure + ' hPa';
            document.getElementById('visibility-value').textContent = (weather.visibility / 1000).toFixed(1) + ' km';
            document.getElementById('feels-like-value').textContent = Math.round(weather.main.feels_like) + '°';
            
            // Wind direction
            const windDirection = getWindDirection(weather.wind.deg);
            document.getElementById('wind-direction').textContent = windDirection;
            
            // Air quality
            if (airQuality) {
                const aqi = airQuality.list[0].main.aqi;
                const aqiText = getAirQualityText(aqi);
                document.getElementById('air-quality-value').textContent = aqiText;
                
                // Color code air quality
                const aqiElement = document.getElementById('air-quality-value');
                aqiElement.style.color = getAirQualityColor(aqi);
            }
            
            // Fetch UV Index
            fetchUVIndex(weather.coord.lat, weather.coord.lon);
            
            // Sunrise/Sunset
            const sunrise = new Date(weather.sys.sunrise * 1000);
            const sunset = new Date(weather.sys.sunset * 1000);
            document.getElementById('sunrise-value').textContent = sunrise.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('sunset-value').textContent = sunset.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
            
            // Update forecast
            updateForecast(forecast);
            
            // Update background based on weather
            updateWeatherBackground(weather.weather[0].main);
            
            // Add weather icon animation
            const weatherIcon = document.getElementById('weather-img');
            weatherIcon.classList.add('animate__animated', 'animate__bounceIn');
            setTimeout(() => {
                weatherIcon.classList.remove('animate__animated', 'animate__bounceIn');
            }, 1000);

            // Auto-speak weather if enabled
            if (voiceSettings.autoSpeak) {
                const tempUnit = currentUnit === 'metric' ? 'Celsius' : 'Fahrenheit';
                const speechText = `Current weather in ${weather.name}: ${weather.weather[0].description}, ${Math.round(weather.main.temp)} degrees ${tempUnit}. Humidity ${weather.main.humidity} percent, wind speed ${Math.round(weather.wind.speed * 3.6)} kilometers per hour.`;
                setTimeout(() => speakWeather(speechText), 1500); // Delay to let animation finish
            }
        }

        // Fetch UV Index
        async function fetchUVIndex(lat, lon) {
            try {
                // Note: OpenWeatherMap's UV Index API requires a different endpoint
                // For now, we'll simulate UV data based on weather conditions
                const uvIndex = Math.floor(Math.random() * 11) + 1; // Simulate UV index 1-11
                document.getElementById('uv-index-value').textContent = uvIndex;
                
                // Color code UV index
                const uvElement = document.getElementById('uv-index-value');
                uvElement.style.color = getUVIndexColor(uvIndex);
            } catch (error) {
                console.error('Error fetching UV index:', error);
                document.getElementById('uv-index-value').textContent = 'N/A';
            }
        }

        // Get wind direction from degrees
        function getWindDirection(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        // Get air quality text
        function getAirQualityText(aqi) {
            const qualities = ['Good', 'Fair', 'Moderate', 'Poor', 'Very Poor'];
            return qualities[aqi - 1] || 'Unknown';
        }

        // Get air quality color
        function getAirQualityColor(aqi) {
            const colors = ['#4cc9f0', '#7fb069', '#f9c74f', '#f8961e', '#f94144'];
            return colors[aqi - 1] || '#ffffff';
        }

        // Get UV index color
        function getUVIndexColor(uvIndex) {
            if (uvIndex <= 2) return '#4cc9f0'; // Low - Blue
            if (uvIndex <= 5) return '#7fb069'; // Moderate - Green
            if (uvIndex <= 7) return '#f9c74f'; // High - Yellow
            if (uvIndex <= 10) return '#f8961e'; // Very High - Orange
            return '#f94144'; // Extreme - Red
        }

        // Update 5-day forecast
        function updateForecast(forecast) {
            const forecastContainer = document.getElementById('forecast-container');
            forecastContainer.innerHTML = '';
            
            // Get daily forecasts (every 8th item = 24 hours)
            const dailyForecasts = forecast.list.filter((item, index) => index % 8 === 0).slice(0, 5);
            
            dailyForecasts.forEach((day, index) => {
                const date = new Date(day.dt * 1000);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                
                const forecastCard = document.createElement('div');
                forecastCard.className = 'forecast-card';
                forecastCard.style.animationDelay = `${index * 0.1}s`;
                
                forecastCard.innerHTML = `
                    <div class="forecast-day">${dayName}</div>
                    <img src="https://openweathermap.org/img/wn/${day.weather[0].icon}@2x.png" 
                         alt="${day.weather[0].description}" class="forecast-icon">
                    <div class="forecast-temps">
                        <span class="forecast-high">${Math.round(day.main.temp_max)}°</span>
                        <span class="forecast-low">${Math.round(day.main.temp_min)}°</span>
                    </div>
                `;
                
                forecastContainer.appendChild(forecastCard);
            });
        }

        // Initialize charts
        function initializeCharts() {
            // Temperature chart
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature',
                        data: [],
                        borderColor: '#4cc9f0',
                        backgroundColor: 'rgba(76, 201, 240, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // Humidity chart
            const humCtx = document.getElementById('humidityChart').getContext('2d');
            humidityChart = new Chart(humCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Humidity %',
                        data: [],
                        backgroundColor: 'rgba(247, 37, 133, 0.8)',
                        borderColor: '#f72585',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        // Update charts with forecast data
        function updateCharts() {
            if (!forecastData) return;
            
            // Get 24-hour data (8 items = 24 hours)
            const hourlyData = forecastData.list.slice(0, 8);
            
            const labels = hourlyData.map(item => {
                const date = new Date(item.dt * 1000);
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            });
            
            const temperatures = hourlyData.map(item => Math.round(item.main.temp));
            const humidity = hourlyData.map(item => item.main.humidity);
            
            // Update temperature chart
            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets[0].data = temperatures;
            temperatureChart.update();
            
            // Update humidity chart
            humidityChart.data.labels = labels;
            humidityChart.data.datasets[0].data = humidity;
            humidityChart.update();
        }

        // Create weather effects (rain, snow, etc.)
        function createWeatherEffects(weatherType) {
            const effectsContainer = document.getElementById('weather-effects');
            effectsContainer.innerHTML = '';
            
            switch (weatherType.toLowerCase()) {
                case 'rain':
                case 'drizzle':
                    createRainEffect(effectsContainer);
                    break;
                case 'snow':
                    createSnowEffect(effectsContainer);
                    break;
            }
        }

        // Create rain effect
        function createRainEffect(container) {
            container.className = 'rain-effect';
            
            for (let i = 0; i < 100; i++) {
                const raindrop = document.createElement('div');
                raindrop.className = 'raindrop';
                raindrop.style.left = Math.random() * 100 + '%';
                raindrop.style.animationDelay = Math.random() * 1 + 's';
                raindrop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                container.appendChild(raindrop);
            }
        }

        // Create snow effect
        function createSnowEffect(container) {
            container.className = 'snow-effect';
            
            for (let i = 0; i < 50; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.innerHTML = '❄';
                snowflake.style.left = Math.random() * 100 + '%';
                snowflake.style.animationDelay = Math.random() * 10 + 's';
                snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                container.appendChild(snowflake);
            }
        }

        // Update background based on weather
        function updateWeatherBackground(weatherType) {
            const body = document.body;
            body.className = ''; // Clear existing classes
            
            switch (weatherType.toLowerCase()) {
                case 'clear':
                    body.classList.add('weather-bg-sunny');
                    break;
                case 'clouds':
                    body.classList.add('weather-bg-cloudy');
                    break;
                case 'rain':
                case 'drizzle':
                    body.classList.add('weather-bg-rainy');
                    break;
                case 'snow':
                    body.classList.add('weather-bg-snowy');
                    break;
            }
        }

        // Switch temperature unit
        function switchUnit(unit) {
            currentUnit = unit;
            
            document.getElementById('unit-c').classList.toggle('active', unit === 'metric');
            document.getElementById('unit-f').classList.toggle('active', unit === 'imperial');
            
            // Save preference
            localStorage.setItem('unit', unit);
            
            if (weatherData) {
                // Re-fetch data with new unit
                fetchWeatherByCity(weatherData.name);
            }
        }

        // Generate smart recommendations
        function generateSmartRecommendations(weather) {
            const temp = weather.main.temp;
            const condition = weather.weather[0].main.toLowerCase();
            const humidity = weather.main.humidity;
            const windSpeed = weather.wind.speed;
            const recommendations = [];

            // Clothing recommendations
            let clothingAdvice = '';
            let clothingIcon = 'fas fa-tshirt';
            let clothingTags = [];

            if (temp < 0) {
                clothingAdvice = 'Very cold! Wear heavy winter coat, gloves, scarf, and warm boots. Layer up!';
                clothingIcon = 'fas fa-snowflake';
                clothingTags = ['Heavy Coat', 'Gloves', 'Scarf', 'Winter Boots'];
            } else if (temp < 10) {
                clothingAdvice = 'Cold weather. Wear a warm jacket, long pants, and closed shoes.';
                clothingIcon = 'fas fa-snowman';
                clothingTags = ['Warm Jacket', 'Long Pants', 'Closed Shoes'];
            } else if (temp < 20) {
                clothingAdvice = 'Cool weather. Light jacket or sweater recommended. Jeans are perfect.';
                clothingIcon = 'fas fa-tshirt';
                clothingTags = ['Light Jacket', 'Sweater', 'Jeans'];
            } else if (temp < 25) {
                clothingAdvice = 'Pleasant weather! Light clothes, t-shirt, and comfortable shoes.';
                clothingIcon = 'fas fa-tshirt';
                clothingTags = ['T-shirt', 'Light Clothes', 'Comfortable Shoes'];
            } else if (temp < 30) {
                clothingAdvice = 'Warm weather. Wear light, breathable clothes. Shorts and t-shirt ideal.';
                clothingIcon = 'fas fa-sun';
                clothingTags = ['Shorts', 'T-shirt', 'Breathable Fabric'];
            } else {
                clothingAdvice = 'Very hot! Wear minimal, light-colored clothes. Stay hydrated!';
                clothingIcon = 'fas fa-fire';
                clothingTags = ['Light Colors', 'Minimal Clothing', 'Sun Hat'];
            }

            recommendations.push({
                icon: clothingIcon,
                title: 'Clothing Advice',
                content: clothingAdvice,
                tags: clothingTags
            });

            // Activity recommendations
            let activityAdvice = '';
            let activityIcon = 'fas fa-running';
            let activityTags = [];

            if (condition.includes('rain')) {
                activityAdvice = 'Rainy day! Perfect for indoor activities like reading, movies, or visiting museums. Bring an umbrella if you must go out.';
                activityIcon = 'fas fa-umbrella';
                activityTags = ['Indoor Activities', 'Museums', 'Reading', 'Movies'];
            } else if (condition.includes('snow')) {
                activityAdvice = 'Snowy weather! Great for winter sports, building snowmen, or cozy indoor activities.';
                activityIcon = 'fas fa-skiing';
                activityTags = ['Winter Sports', 'Skiing', 'Indoor Fun', 'Hot Drinks'];
            } else if (temp > 20 && condition.includes('clear')) {
                activityAdvice = 'Beautiful clear weather! Perfect for outdoor activities like hiking, cycling, picnics, or sports.';
                activityIcon = 'fas fa-mountain';
                activityTags = ['Hiking', 'Cycling', 'Picnics', 'Outdoor Sports'];
            } else if (windSpeed > 5) {
                activityAdvice = 'Windy conditions! Good for flying kites or wind sports, but be careful with outdoor activities.';
                activityIcon = 'fas fa-wind';
                activityTags = ['Kite Flying', 'Wind Sports', 'Be Careful'];
            } else {
                activityAdvice = 'Moderate weather. Good for most outdoor activities. Walking, jogging, or casual outdoor dining.';
                activityIcon = 'fas fa-walking';
                activityTags = ['Walking', 'Jogging', 'Outdoor Dining'];
            }

            recommendations.push({
                icon: activityIcon,
                title: 'Activity Suggestions',
                content: activityAdvice,
                tags: activityTags
            });

            // Health & comfort recommendations
            let healthAdvice = '';
            let healthIcon = 'fas fa-heart';
            let healthTags = [];

            if (humidity > 80) {
                healthAdvice = 'High humidity! Stay hydrated, use a dehumidifier indoors, and take breaks in air-conditioned spaces.';
                healthIcon = 'fas fa-tint';
                healthTags = ['Stay Hydrated', 'Dehumidifier', 'AC Breaks'];
            } else if (humidity < 30) {
                healthAdvice = 'Low humidity! Use moisturizer, drink plenty of water, and consider a humidifier for comfort.';
                healthIcon = 'fas fa-droplet';
                healthTags = ['Moisturizer', 'Drink Water', 'Humidifier'];
            } else if (temp > 30) {
                healthAdvice = 'Hot weather! Stay in shade, drink water regularly, wear sunscreen, and avoid strenuous outdoor activities during peak hours.';
                healthIcon = 'fas fa-sun';
                healthTags = ['Stay in Shade', 'Sunscreen', 'Regular Water'];
            } else {
                healthAdvice = 'Comfortable conditions! Great weather for maintaining your regular activities and routines.';
                healthIcon = 'fas fa-smile';
                healthTags = ['Comfortable', 'Regular Activities', 'Enjoy Weather'];
            }

            recommendations.push({
                icon: healthIcon,
                title: 'Health & Comfort',
                content: healthAdvice,
                tags: healthTags
            });

            // Display recommendations
            displayRecommendations(recommendations);
        }

        // Display recommendations in the UI
        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendations-grid');
            container.innerHTML = '';

            recommendations.forEach((rec, index) => {
                const card = document.createElement('div');
                card.className = 'recommendation-card';
                card.style.animationDelay = `${index * 0.1}s`;

                card.innerHTML = `
                    <div class="recommendation-header">
                        <i class="${rec.icon} recommendation-icon"></i>
                        <div class="recommendation-title">${rec.title}</div>
                    </div>
                    <div class="recommendation-content">${rec.content}</div>
                    <div class="recommendation-tags">
                        ${rec.tags.map(tag => `<span class="recommendation-tag">${tag}</span>`).join('')}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Set current date
        function setCurrentDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('date').textContent = today.toLocaleDateString('en-US', options);
        }

        // Show loading state
        function showLoading() {
            const searchBtn = document.getElementById('search-btn');
            searchBtn.innerHTML = '<div class="loading"></div>';
            searchBtn.disabled = true;
        }

        // Hide loading state
        function hideLoading() {
            const searchBtn = document.getElementById('search-btn');
            searchBtn.innerHTML = '<i class="fas fa-search"></i>';
            searchBtn.disabled = false;
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Save recent search
        function saveRecentSearch(city) {
            let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            
            // Remove if already exists
            recentSearches = recentSearches.filter(search => search.toLowerCase() !== city.toLowerCase());
            
            // Add to beginning
            recentSearches.unshift(city);
            
            // Keep only last 5
            recentSearches = recentSearches.slice(0, 5);
            
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            updateRecentSearches();
        }

        // Cache weather data for offline use
        function cacheWeatherData(city, data) {
            const cacheData = {
                timestamp: Date.now(),
                city: city,
                weather: data.weather,
                forecast: data.forecast
            };
            
            localStorage.setItem(`weather_${city.toLowerCase()}`, JSON.stringify(cacheData));
        }

        // Get cached weather data
        function getCachedWeatherData(city) {
            const cached = localStorage.getItem(`weather_${city.toLowerCase()}`);
            if (!cached) return null;
            
            const data = JSON.parse(cached);
            const now = Date.now();
            const oneHour = 60 * 60 * 1000;
            
            // Return cached data if less than 1 hour old
            if (now - data.timestamp < oneHour) {
                return data;
            }
            
            return null;
        }

        // Handle offline state
        function handleOfflineState() {
            if (!navigator.onLine) {
                showNotification('You are offline. Showing cached data.', 'warning');
                
                // Try to load last viewed city from cache
                const recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
                if (recentSearches.length > 0) {
                    const cachedData = getCachedWeatherData(recentSearches[0]);
                    if (cachedData) {
                        updateWeatherDisplay(cachedData.weather, cachedData.forecast);
                        hideLoading();
                    }
                }
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', () => {
            showNotification('Back online! Refreshing weather data...', 'success');
            if (weatherData) {
                fetchWeatherByCity(weatherData.name);
            }
        });

        window.addEventListener('offline', () => {
            showNotification('You are now offline. App will use cached data.', 'warning');
        });

        // Update recent searches display
        function updateRecentSearches() {
            const recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            const container = document.getElementById('recent-list');
            
            container.innerHTML = '';
            
            recentSearches.forEach(city => {
                const tag = document.createElement('div');
                tag.className = 'recent-tag';
                tag.textContent = city;
                tag.addEventListener('click', () => {
                    document.getElementById('city-input').value = city;
                    searchWeather();
                });
                container.appendChild(tag);
            });
        }

        // Auto-refresh weather data every 10 minutes
        setInterval(() => {
            if (weatherData) {
                fetchWeatherByCity(weatherData.name);
            }
        }, 600000); // 10 minutes

        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('✅ Service Worker registered:', registration);
                })
                .catch(error => {
                    console.log('❌ Service Worker registration failed:', error);
                });
        }

        // Initialize recent searches on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateRecentSearches();
        });

        // Note: The backend now handles API key management
        // No need to expose API keys in frontend code!
    </script>
</body>
</html>